# 数据处理脚本使用说明

## 📋 脚本列表

### 1. data_filling.py - 人口数据填充脚本
**功能**：生成并插入模拟人口数据到population表

**使用方法**：
```bash
python data_filling.py [线程数] [批次大小]
```

**示例**：
```bash
python data_filling.py 2 800
```

---

### 2. death_archive.py - 死亡人口归档脚本
**功能**：
- 从population表随机选择10%的人口
- 为他们生成合理的死亡日期
- 将数据移至population_deceased表
- 从population表中删除

**使用方法**：
```bash
python death_archive.py
```

**特点**：
- ✅ 自动生成合理的死亡日期（死亡日期在出生日期之后，不晚于今天）
- ✅ 成年人70%在最近10年内死亡（符合现实规律）
- ✅ 每100条提交一次，提高效率
- ✅ 有确认提示，防止误操作
- ✅ 显示示例记录和统计信息

**运行示例**：
```
⚠️  警告：此操作将从population表中删除10%的数据并移至population_deceased表！
确认继续？(yes/no): yes
============================================================
死亡人口归档脚本
============================================================
死亡比例: 10.0%
============================================================
正在连接数据库...
数据库连接成功！
总人口数: 100,000
需要归档的死亡人口: 10,000

正在随机选择人口...
已选择 10,000 人

开始归档死亡人口...
进度: 100/10000 (1.0%)
进度: 200/10000 (2.0%)
...
============================================================
归档完成！
============================================================
成功归档: 9,998 条
失败: 2 条
原人口表剩余: 90,000 条
============================================================

示例死亡记录：
  王小明 | 男 | 生于1950-03-15 | 卒于2020-08-23 | 享年70岁
  李华 | 女 | 生于1985-06-10 | 卒于2023-11-05 | 享年38岁
  ...
```

---

### 3. marriage_register.py - 婚姻登记脚本
**功能**：
- 从population表随机选择0.4%的人口
- 男女随机配对
- 生成合理的结婚日期
- 插入marriage_info表

**使用方法**：
```bash
python marriage_register.py
```

**特点**：
- ✅ 自动检查年龄（必须满18岁才能结婚）
- ✅ 结婚日期在双方都满18岁之后
- ✅ 男女随机配对
- ✅ 自动处理重复键冲突
- ✅ 有确认提示
- ✅ 显示示例记录和统计信息

**运行示例**：
```
📝 此操作将在marriage_info表中插入随机婚姻记录
确认继续？(yes/no): yes
============================================================
婚姻登记脚本
============================================================
结婚比例: 0.4%
============================================================
正在连接数据库...
数据库连接成功！
总人口数: 100,000
需要结婚的人数: 400
需要登记的夫妇数: 200

正在加载人口数据...
男性人口: 50,123
女性人口: 49,877

正在随机选择配对对象...
实际配对夫妇数: 200

开始登记婚姻...
进度: 100/200 (50.0%)
进度: 200/200 (100.0%)

============================================================
婚姻登记完成！
============================================================
成功登记: 195 对
失败: 0 对
因年龄不够跳过: 5 对
============================================================

示例婚姻记录：
  张三(110101199001011234) ❤️  李四(110102199203022345) | 结婚日期: 2015-05-20
  王五(130102198805153456) ❤️  赵六(130104198907264567) | 结婚日期: 2018-10-01
  ...

数据库中共有 195 对夫妇
```

---

### 4. test_data_filling.py - 测试脚本
**功能**：快速测试data_filling.py的功能（只生成30条数据）

**使用方法**：
```bash
python test_data_filling.py
```

---

## 🔄 推荐使用顺序

### 完整数据生成流程

1. **填充人口数据**
```bash
python data_filling.py 2 800
```
预计生成约14万条人口记录

2. **归档死亡人口**（10%）
```bash
python death_archive.py
```
会将约1.4万条记录移至死亡表

3. **登记婚姻信息**（0.4%）
```bash
python marriage_register.py
```
会生成约500对夫妇的婚姻记录

---

## 📊 数据统计

完成所有脚本后的预期数据量：

| 表名 | 记录数 | 说明 |
|------|--------|------|
| population | 约126,000条 | 存活人口（原14万 - 10%死亡） |
| population_deceased | 约14,000条 | 死亡人口（10%） |
| marriage_info | 约500对 | 婚姻记录（总人口的0.4%） |

---

## 🔍 数据验证SQL

### 验证人口表
```sql
-- 查看人口总数
SELECT COUNT(*) as total FROM population;

-- 按性别统计
SELECT gender, COUNT(*) as count FROM population GROUP BY gender;

-- 按民族统计（应该91%是汉族）
SELECT 
    CASE WHEN ethnicity = '汉族' THEN '汉族' ELSE '其他' END as ethnic_group,
    COUNT(*) as count,
    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM population), 2) as percentage
FROM population
GROUP BY ethnic_group;
```

### 验证死亡表
```sql
-- 查看死亡人口总数
SELECT COUNT(*) as total FROM population_deceased;

-- 查看年龄分布
SELECT 
    CASE 
        WHEN TIMESTAMPDIFF(YEAR, birth_date, death_date) < 18 THEN '未成年'
        WHEN TIMESTAMPDIFF(YEAR, birth_date, death_date) < 60 THEN '中年'
        ELSE '老年'
    END as age_group,
    COUNT(*) as count
FROM population_deceased
GROUP BY age_group;

-- 查看最近死亡记录
SELECT name, gender, birth_date, death_date,
       TIMESTAMPDIFF(YEAR, birth_date, death_date) as age
FROM population_deceased
ORDER BY death_date DESC
LIMIT 10;
```

### 验证婚姻表
```sql
-- 查看婚姻总数
SELECT COUNT(*) as total_couples FROM marriage_info;

-- 验证婚姻记录中的人是否都存在于人口表
SELECT COUNT(*) as invalid_marriages
FROM marriage_info m
WHERE NOT EXISTS (SELECT 1 FROM population WHERE id_no = m.male_id_no)
   OR NOT EXISTS (SELECT 1 FROM population WHERE id_no = m.female_id_no);

-- 查看最近的婚姻记录
SELECT male_name, female_name, marriage_date
FROM marriage_info
ORDER BY marriage_date DESC
LIMIT 10;

-- 统计结婚年份分布
SELECT YEAR(marriage_date) as year, COUNT(*) as count
FROM marriage_info
GROUP BY year
ORDER BY year DESC;
```

---

## ⚠️ 注意事项

### 1. death_archive.py
- ⚠️ **会删除数据**：此脚本会从population表中删除10%的数据
- 建议先备份数据库或在测试环境运行
- 运行前会有确认提示，请仔细阅读

### 2. marriage_register.py
- 依赖population表中的数据
- 如果先运行death_archive.py，可用于结婚的人口会减少
- 建议在death_archive.py之前运行

### 3. 外键约束
- marriage_info表有外键约束，引用population表的id_no
- 如果先登记婚姻再归档死亡，可能导致外键约束冲突
- **推荐顺序**：填充人口 → 登记婚姻 → 归档死亡

### 4. 性能建议
- death_archive.py处理10%数据可能需要5-15分钟
- marriage_register.py通常在1-3分钟内完成
- 建议在数据库负载较低时运行

---

## 🐛 故障排除

### 问题1：外键约束错误
```
Error: Cannot add or update a child row: a foreign key constraint fails
```
**解决方案**：
- 确保population表中有足够的数据
- 先运行marriage_register.py再运行death_archive.py

### 问题2：连接超时
```
Error: Lost connection to MySQL server
```
**解决方案**：
- 检查网络连接
- 减少批次大小
- 检查数据库服务器状态

### 问题3：重复键错误
```
Error: Duplicate entry for key 'PRIMARY'
```
**解决方案**：
- marriage_register.py会自动跳过重复键
- death_archive.py会报告失败但继续执行

---

## 📝 自定义配置

### 修改死亡比例
编辑 `death_archive.py`：
```python
DEATH_RATIO = 0.10  # 改为你想要的比例，如0.15表示15%
```

### 修改结婚比例
编辑 `marriage_register.py`：
```python
MARRIAGE_RATIO = 0.004  # 改为你想要的比例，如0.01表示1%
```

### 修改数据库配置
两个脚本都使用相同的配置：
```python
MYSQL_CONFIG = {

```

---

## 📞 技术支持

如有问题，请检查：
1. Python版本（建议3.7+）
2. pymysql库是否已安装
3. 数据库连接是否正常
4. 表结构是否正确创建

**祝使用愉快！** 🎉

