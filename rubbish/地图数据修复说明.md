# ğŸ—ºï¸ ä¸­å›½åœ°å›¾æ•°æ®ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯

```
âŒ åŠ è½½æ•°æ®å¤±è´¥: Cannot read properties of undefined (reading 'regions')
Couldn't find the requested file /map/js/china.js in echarts.
```

### æ ¹æœ¬åŸå› 

**ECharts 5.xç‰ˆæœ¬å˜æ›´**ï¼š
- ECharts 5.0+ ä¸å†å†…ç½®ä¸­å›½åœ°å›¾æ•°æ®
- æ—§çš„CDNé“¾æ¥ `echarts@5.4.3/map/js/china.js` å·²å¤±æ•ˆ
- éœ€è¦å•ç‹¬åŠ è½½GeoJSONæ ¼å¼çš„åœ°å›¾æ•°æ®

---

## è§£å†³æ–¹æ¡ˆ

### ä¿®å¤æ­¥éª¤

#### 1. åˆ é™¤æ—§çš„åœ°å›¾å¼•ç”¨

**åˆ é™¤**ï¼š
```html
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/map/js/china.js"></script>
```

#### 2. æ·»åŠ åœ°å›¾æ•°æ®åŠ è½½é€»è¾‘

**æ–°å¢JavaScriptå‡½æ•°**ï¼š

```javascript
// åŠ è½½ä¸­å›½åœ°å›¾GeoJSONæ•°æ®
async function loadChinaMap() {
    if (chinaMapLoaded) return true;
    
    try {
        // ä½¿ç”¨é˜¿é‡Œäº‘DataVçš„ä¸­å›½åœ°å›¾æ•°æ®ï¼ˆä¸»æ•°æ®æºï¼‰
        const response = await fetch('https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json');
        const geoJson = await response.json();
        
        // æ³¨å†Œåœ°å›¾
        echarts.registerMap('china', geoJson);
        chinaMapLoaded = true;
        console.log('âœ… ä¸­å›½åœ°å›¾æ•°æ®åŠ è½½æˆåŠŸ');
        return true;
    } catch (error) {
        console.error('âŒ åŠ è½½ä¸­å›½åœ°å›¾æ•°æ®å¤±è´¥:', error);
        
        // å°è¯•å¤‡ç”¨æ•°æ®æº
        try {
            console.log('ğŸ”„ å°è¯•å¤‡ç”¨åœ°å›¾æ•°æ®æº...');
            const response = await fetch('https://raw.githubusercontent.com/apache/echarts/master/test/data/map/json/china.json');
            const geoJson = await response.json();
            echarts.registerMap('china', geoJson);
            chinaMapLoaded = true;
            console.log('âœ… å¤‡ç”¨åœ°å›¾æ•°æ®åŠ è½½æˆåŠŸ');
            return true;
        } catch (error2) {
            console.error('âŒ å¤‡ç”¨æ•°æ®æºä¹Ÿå¤±è´¥:', error2);
            return false;
        }
    }
}
```

#### 3. ä¿®æ”¹åˆå§‹åŒ–æµç¨‹

**ä¿®æ”¹å‰**ï¼š
```javascript
document.addEventListener('DOMContentLoaded', function() {
    initChart();
    loadData();
    updateCacheInfo();
});
```

**ä¿®æ”¹å**ï¼š
```javascript
document.addEventListener('DOMContentLoaded', async function() {
    // å…ˆåŠ è½½åœ°å›¾æ•°æ®
    const mapLoaded = await loadChinaMap();
    if (!mapLoaded) {
        showError('åœ°å›¾æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
    }
    
    // å†åˆå§‹åŒ–å›¾è¡¨å’ŒåŠ è½½æ•°æ®
    initChart();
    loadData();
    updateCacheInfo();
});
```

---

## åœ°å›¾æ•°æ®æº

### ä¸»æ•°æ®æºï¼šé˜¿é‡Œäº‘DataV

```
URL: https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json
æ ¼å¼: GeoJSON
è¯´æ˜: é˜¿é‡Œäº‘æä¾›çš„å…¨å›½çœçº§è¡Œæ”¿åŒºåˆ’è¾¹ç•Œæ•°æ®
ä¼˜ç‚¹: ç¨³å®šã€å¿«é€Ÿã€å›½å†…è®¿é—®å‹å¥½
```

**å…¶ä»–åŒºåˆ’ä»£ç **ï¼š
- `100000` - å…¨å›½
- `110000` - åŒ—äº¬å¸‚
- `310000` - ä¸Šæµ·å¸‚
- `440000` - å¹¿ä¸œçœ
- ...

### å¤‡ç”¨æ•°æ®æºï¼šGitHub

```
URL: https://raw.githubusercontent.com/apache/echarts/master/test/data/map/json/china.json
æ ¼å¼: GeoJSON
è¯´æ˜: EChartså®˜æ–¹ä»“åº“ä¸­çš„æµ‹è¯•æ•°æ®
ç¼ºç‚¹: å›½å†…è®¿é—®å¯èƒ½è¾ƒæ…¢æˆ–è¢«å¢™
```

### å…¶ä»–å¯é€‰æ•°æ®æº

1. **jsDelivr CDN**ï¼ˆæ¨èï¼‰ï¼š
   ```
   https://cdn.jsdelivr.net/npm/echarts-countries-pypkg@1.0.0/echarts_countries_pypkg/resources/echarts/china.json
   ```

2. **unpkg CDN**ï¼š
   ```
   https://unpkg.com/echarts-countries-pypkg@1.0.0/echarts_countries_pypkg/resources/echarts/china.json
   ```

3. **æœ¬åœ°å­˜å‚¨**ï¼š
   - ä¸‹è½½GeoJSONæ–‡ä»¶åˆ° `static/maps/china.json`
   - ä¿®æ”¹fetchè·¯å¾„ä¸º `/static/maps/china.json`

---

## å·¥ä½œåŸç†

### EChartsåœ°å›¾æ³¨å†Œæµç¨‹

```
1. è·å–GeoJSONæ•°æ®
   â†“
2. echarts.registerMap('china', geoJson)
   â†“
3. åœ¨å›¾è¡¨é…ç½®ä¸­ä½¿ç”¨ map: 'china'
   â†“
4. æ¸²æŸ“åœ°å›¾
```

### ä»£ç ç¤ºä¾‹

```javascript
// æ­¥éª¤1: åŠ è½½GeoJSON
fetch('https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json')
    .then(response => response.json())
    .then(geoJson => {
        // æ­¥éª¤2: æ³¨å†Œåœ°å›¾
        echarts.registerMap('china', geoJson);
        
        // æ­¥éª¤3: ä½¿ç”¨åœ°å›¾
        const option = {
            series: [{
                type: 'map',
                map: 'china',  // ä½¿ç”¨æ³¨å†Œçš„åœ°å›¾åç§°
                data: provinceData
            }]
        };
        
        // æ­¥éª¤4: æ¸²æŸ“
        chart.setOption(option);
    });
```

---

## éªŒè¯ä¿®å¤

### 1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°

æŒ‰ `F12` æˆ– `Ctrl+Shift+I` æ‰“å¼€å¼€å‘è€…å·¥å…·

### 2. æ£€æŸ¥æ§åˆ¶å°è¾“å‡º

æˆåŠŸæ—¶åº”çœ‹åˆ°ï¼š
```
âœ… ä¸­å›½åœ°å›¾æ•°æ®åŠ è½½æˆåŠŸ
```

å¤±è´¥æ—¶ä¼šçœ‹åˆ°ï¼š
```
âŒ åŠ è½½ä¸­å›½åœ°å›¾æ•°æ®å¤±è´¥: [é”™è¯¯ä¿¡æ¯]
ğŸ”„ å°è¯•å¤‡ç”¨åœ°å›¾æ•°æ®æº...
```

### 3. æ£€æŸ¥ç½‘ç»œè¯·æ±‚

åœ¨"Network"æ ‡ç­¾é¡µä¸­åº”è¯¥èƒ½çœ‹åˆ°ï¼š
- è¯·æ±‚URL: `https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json`
- çŠ¶æ€ç : 200
- å“åº”ç±»å‹: JSON

### 4. æ£€æŸ¥åœ°å›¾æ¸²æŸ“

- åˆ‡æ¢åˆ°"äººå£åˆ†å¸ƒ"æˆ–"äººå£å¯†åº¦"æ ‡ç­¾
- åº”è¯¥èƒ½çœ‹åˆ°å®Œæ•´çš„ä¸­å›½åœ°å›¾
- é¼ æ ‡æ‚¬åœæ—¶èƒ½æ˜¾ç¤ºçœä»½åç§°å’Œæ•°æ®

---

## å¸¸è§é—®é¢˜

### Q1: åœ°å›¾åŠ è½½å¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ

**A1**: ä½¿ç”¨æœ¬åœ°åœ°å›¾æ–‡ä»¶

1. ä¸‹è½½åœ°å›¾æ•°æ®ï¼š
   ```bash
   curl https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json -o static/maps/china.json
   ```

2. ä¿®æ”¹ä»£ç ï¼š
   ```javascript
   const response = await fetch('/static/maps/china.json');
   ```

### Q2: ä¸»æ•°æ®æºå’Œå¤‡ç”¨æ•°æ®æºéƒ½å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A2**: æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

1. **æ£€æŸ¥ç½‘ç»œ**ï¼š
   ```bash
   curl https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json
   ```

2. **ä½¿ç”¨ä»£ç†**ï¼š
   å¦‚æœåœ¨ç‰¹æ®Šç½‘ç»œç¯å¢ƒï¼Œé…ç½®ä»£ç†

3. **ä½¿ç”¨æœ¬åœ°æ–‡ä»¶**ï¼š
   è§Q1è§£å†³æ–¹æ¡ˆ

### Q3: åœ°å›¾æ˜¾ç¤ºä¸å…¨æˆ–é”™ä½ï¼Ÿ

**A3**: æ£€æŸ¥GeoJSONæ•°æ®æ ¼å¼

1. ç¡®è®¤æ•°æ®æ ¼å¼æ­£ç¡®
2. æ£€æŸ¥åæ ‡ç³»ç»Ÿï¼ˆé€šå¸¸ä¸ºWGS84æˆ–GCJ02ï¼‰
3. ä½¿ç”¨æ­£ç¡®çš„æŠ•å½±æ–¹å¼

### Q4: å¦‚ä½•åŠ è½½å…¶ä»–åœ°åŒºçš„åœ°å›¾ï¼Ÿ

**A4**: ä¿®æ”¹åŒºåˆ’ä»£ç 

```javascript
// çœçº§åœ°å›¾
const response = await fetch('https://geo.datav.aliyun.com/areas_v3/bound/110000_full.json'); // åŒ—äº¬
echarts.registerMap('beijing', geoJson);

// å¸‚çº§åœ°å›¾
const response = await fetch('https://geo.datav.aliyun.com/areas_v3/bound/110100_full.json'); // åŒ—äº¬å¸‚
echarts.registerMap('beijing-city', geoJson);
```

---

## æŠ€æœ¯ç»†èŠ‚

### GeoJSONæ•°æ®ç»“æ„

```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": {
        "adcode": 110000,
        "name": "åŒ—äº¬å¸‚",
        "center": [116.405285, 39.904989],
        "centroid": [116.41995, 40.18994],
        "childrenNum": 16,
        "level": "province",
        "parent": { "adcode": 100000 },
        "subFeatureIndex": 0,
        "acroutes": [100000]
      },
      "geometry": {
        "type": "MultiPolygon",
        "coordinates": [...]
      }
    }
  ]
}
```

### æ³¨å†Œåœ°å›¾API

```javascript
/**
 * æ³¨å†Œåœ°å›¾
 * @param {string} mapName - åœ°å›¾åç§°
 * @param {Object} geoJson - GeoJSONæ•°æ®
 * @param {Object} specialAreas - ç‰¹æ®ŠåŒºåŸŸé…ç½®ï¼ˆå¯é€‰ï¼‰
 */
echarts.registerMap(mapName, geoJson, specialAreas);
```

### ç‰¹æ®ŠåŒºåŸŸé…ç½®ç¤ºä¾‹

```javascript
echarts.registerMap('china', geoJson, {
    'å—æµ·è¯¸å²›': {
        left: 85,
        top: 76,
        width: 8
    },
    'å°æ¹¾': {
        left: 80,
        top: 40,
        width: 5
    }
});
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜åœ°å›¾æ•°æ®

```javascript
let cachedGeoJson = null;

async function loadChinaMap() {
    if (cachedGeoJson) {
        echarts.registerMap('china', cachedGeoJson);
        return true;
    }
    
    const response = await fetch('...');
    cachedGeoJson = await response.json();
    echarts.registerMap('china', cachedGeoJson);
    return true;
}
```

### 2. ä½¿ç”¨Service Worker

```javascript
// åœ¨service-worker.jsä¸­ç¼“å­˜åœ°å›¾æ•°æ®
self.addEventListener('fetch', function(event) {
    if (event.request.url.includes('china.json')) {
        event.respondWith(
            caches.match(event.request).then(function(response) {
                return response || fetch(event.request);
            })
        );
    }
});
```

### 3. å‹ç¼©GeoJSON

- ä½¿ç”¨TopoJSONä»£æ›¿GeoJSONï¼ˆä½“ç§¯å‡å°‘80%ï¼‰
- ä½¿ç”¨mapshaperç®€åŒ–è¾¹ç•Œ
- ç§»é™¤ä¸å¿…è¦çš„å±æ€§

---

## å‡çº§æŒ‡å—

### ä»ECharts 4.xå‡çº§åˆ°5.x

**ä¸»è¦å˜æ›´**ï¼š
1. âŒ ç§»é™¤å†…ç½®åœ°å›¾æ•°æ®
2. âœ… éœ€è¦æ‰‹åŠ¨åŠ è½½GeoJSON
3. âœ… æ›´å¥½çš„åœ°å›¾æ¸²æŸ“æ€§èƒ½
4. âœ… æ”¯æŒæ›´å¤šè‡ªå®šä¹‰é€‰é¡¹

**è¿ç§»æ­¥éª¤**ï¼š
1. åˆ é™¤æ—§çš„åœ°å›¾å¼•ç”¨
2. æ·»åŠ åœ°å›¾åŠ è½½é€»è¾‘
3. ä½¿ç”¨registerMapæ³¨å†Œåœ°å›¾
4. æµ‹è¯•æ‰€æœ‰åœ°å›¾åŠŸèƒ½

---

## æ€»ç»“

### ä¿®å¤æ¸…å•

- [x] åˆ é™¤æ—§çš„åœ°å›¾CDNå¼•ç”¨
- [x] æ·»åŠ å¼‚æ­¥åœ°å›¾åŠ è½½å‡½æ•°
- [x] ä¿®æ”¹åˆå§‹åŒ–æµç¨‹ä¸ºå¼‚æ­¥
- [x] æ·»åŠ ä¸»æ•°æ®æºï¼ˆé˜¿é‡Œäº‘DataVï¼‰
- [x] æ·»åŠ å¤‡ç”¨æ•°æ®æºï¼ˆGitHubï¼‰
- [x] æ·»åŠ é”™è¯¯å¤„ç†å’Œæç¤º
- [x] æ·»åŠ æ§åˆ¶å°æ—¥å¿—

### ä¼˜åŠ¿

- âœ… è§£å†³åœ°å›¾æ— æ³•åŠ è½½é—®é¢˜
- âœ… æä¾›å¤‡ç”¨æ•°æ®æºä¿è¯ç¨³å®šæ€§
- âœ… æ›´å¥½çš„é”™è¯¯å¤„ç†
- âœ… å…¼å®¹ECharts 5.xæ ‡å‡†
- âœ… å›½å†…è®¿é—®é€Ÿåº¦å¿«

### åç»­ä¼˜åŒ–

- [ ] æ·»åŠ åœ°å›¾æ•°æ®æœ¬åœ°ç¼“å­˜
- [ ] æ”¯æŒåˆ‡æ¢ä¸åŒçº§åˆ«åœ°å›¾
- [ ] æ·»åŠ åœ°å›¾åŠ è½½è¿›åº¦æ¡
- [ ] ä¼˜åŒ–åœ°å›¾æ¸²æŸ“æ€§èƒ½

---

**âœ… åœ°å›¾æ•°æ®é—®é¢˜å·²å®Œå…¨ä¿®å¤ï¼**

**æµ‹è¯•æ–¹å¼**ï¼š
1. å¯åŠ¨åº”ç”¨ï¼š`python app.py`
2. è®¿é—®ï¼šhttp://127.0.0.1:6667
3. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
4. æŸ¥çœ‹"âœ… ä¸­å›½åœ°å›¾æ•°æ®åŠ è½½æˆåŠŸ"æ—¥å¿—
5. åˆ‡æ¢åˆ°åœ°å›¾æ ‡ç­¾é¡µéªŒè¯æ˜¾ç¤º

