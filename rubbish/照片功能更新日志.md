# 照片功能更新日志 - v2.2.0

## 📋 更新概述

**更新日期**：2025-11-09  
**版本**：v2.2.0  
**主要功能**：身份证照片自动保存

---

## ✨ 新增功能

### 1. 身份证照片自动保存

当用户通过OCR识别上传身份证照片时：
- ✅ 自动保存照片到 `images/` 目录
- ✅ 文件名格式：`身份证号_YYYYMMDD_HHMMSS.jpg`
- ✅ 将存储路径记录到数据库 `id_card_photo` 字段

**示例**：
```
身份证号：110101199001011234
保存时间：2025-11-09 15:30:45
文件名：110101199001011234_20251109_153045.jpg
存储路径：images/110101199001011234_20251109_153045.jpg
```

---

## 🗄️ 数据库变更

### 新增字段

在 `population` 表中新增：

```sql
ALTER TABLE population 
ADD COLUMN id_card_photo VARCHAR(255) DEFAULT NULL COMMENT '身份证照片存储路径';
```

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `id_card_photo` | VARCHAR(255) | NULL | 身份证照片存储路径 |

**影响**：
- 现有数据：`id_card_photo` 自动为 `NULL`
- OCR导入：自动填充照片路径
- Excel导入：保持为 `NULL`

---

## 📝 代码变更

### 修改的文件

| 文件 | 变更内容 | 行数变化 |
|------|---------|---------|
| `id_card_app.py` | 添加照片保存功能 | +60行 |

### 新增的函数

#### `save_id_card_photo(image, id_no)`

**功能**：保存身份证照片到images目录

**参数**：
- `image`: PIL Image对象
- `id_no`: 身份证号

**返回值**：照片存储路径（字符串）

**实现**：
```python
def save_id_card_photo(image, id_no):
    # 确保images目录存在
    images_dir = 'images'
    if not os.path.exists(images_dir):
        os.makedirs(images_dir)
    
    # 生成文件名
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    filename = f"{id_no}_{timestamp}.jpg"
    filepath = os.path.join(images_dir, filename)
    
    # 保存图片
    image.save(filepath, 'JPEG', quality=95)
    
    return filepath
```

### 修改的函数

#### `process_id_card_data()`

**变更**：添加 `photo_path` 参数

**旧版本**：
```python
def process_id_card_data(ocr_result, province_data, source_code):
    ...
```

**新版本**：
```python
def process_id_card_data(ocr_result, province_data, source_code, photo_path=None):
    ...
    person_data = {
        ...
        'id_card_photo': photo_path  # 新增
    }
```

#### `save_to_database()`

**变更**：SQL语句添加 `id_card_photo` 字段

**旧版本**：
```python
sql = """
INSERT INTO population 
(..., source)
VALUES 
(..., %s)
"""
```

**新版本**：
```python
sql = """
INSERT INTO population 
(..., source, id_card_photo)
VALUES 
(..., %s, %s)
"""
```

#### `excel_to_person_data()`

**变更**：添加 `id_card_photo` 字段（值为 None）

```python
person_data = {
    ...
    'id_card_photo': None  # Excel导入不包含照片
}
```

### OCR识别流程变更

**旧版本**：
```python
# OCR识别
ocr_result = recognize_id_card(image_bytes)

# 处理数据
person_data = process_id_card_data(ocr_result, province_data, source_code)
```

**新版本**：
```python
# OCR识别
ocr_result = recognize_id_card(image_bytes)

# 保存照片
id_no = ocr_result.get('id_no', '')
if id_no and len(id_no) == 18:
    photo_path = save_id_card_photo(image, id_no)
else:
    photo_path = None

# 处理数据（包含照片路径）
person_data = process_id_card_data(ocr_result, province_data, source_code, photo_path)
```

---

## 📁 新增文件

### 1. SQL脚本

**文件**：`OCR/add_photo_column.sql`

**用途**：添加 `id_card_photo` 字段到数据库

**内容**：
```sql
ALTER TABLE population 
ADD COLUMN id_card_photo VARCHAR(255) DEFAULT NULL;
```

### 2. 使用文档

| 文件名 | 说明 |
|--------|------|
| `身份证照片存储功能说明.md` | 完整的功能说明文档 |
| `执行步骤.md` | 快速开始指南 |
| `照片功能更新日志.md` | 本文件 |

---

## 🎯 使用方法

### 执行步骤

1. **添加数据库列**
```sql
ALTER TABLE population ADD COLUMN id_card_photo VARCHAR(255) DEFAULT NULL;
```

2. **重启系统**
```bash
streamlit run id_card_app.py
```

3. **测试OCR识别**
- 上传身份证照片
- 系统自动保存到 `images/` 目录
- 显示提示：📸 身份证照片已保存至：xxx

---

## 📊 功能对比

### OCR识别（v2.1 vs v2.2）

| 功能 | v2.1 | v2.2 |
|------|------|------|
| 识别身份证 | ✅ | ✅ |
| 保存照片 | ❌ | ✅ |
| 记录路径 | ❌ | ✅ |
| 查看原始照片 | ❌ | ✅ |

### Excel导入

| 功能 | v2.1 | v2.2 |
|------|------|------|
| 批量导入 | ✅ | ✅ |
| 包含照片 | ❌ | ❌ |
| `id_card_photo` | N/A | NULL |

---

## 🔍 测试用例

### 测试1：OCR识别保存照片

**步骤**：
1. 上传身份证照片
2. 点击"开始识别"
3. 查看识别结果

**预期结果**：
- ✅ 显示：📸 身份证照片已保存至：images/身份证号_时间戳.jpg
- ✅ `images/` 目录中存在对应文件
- ✅ 数据库 `id_card_photo` 字段有值

### 测试2：Excel批量导入

**步骤**：
1. 上传Excel文件
2. 批量导入

**预期结果**：
- ✅ 数据正常导入
- ✅ `id_card_photo` 字段为 NULL
- ✅ 不影响其他字段

### 测试3：数据查询

**SQL**：
```sql
SELECT id_no, name, id_card_photo FROM population ORDER BY processed_at DESC LIMIT 10;
```

**预期结果**：
- OCR导入的记录：`id_card_photo` 有路径
- Excel导入的记录：`id_card_photo` 为 NULL
- 旧数据：`id_card_photo` 为 NULL

---

## ⚠️ 注意事项

### 1. 数据库兼容性

- ✅ 向后兼容：旧数据 `id_card_photo` 自动为 NULL
- ✅ 不影响现有功能
- ✅ Excel导入正常工作

### 2. 存储空间

- 每张照片约 200KB
- 1000张照片约 200MB
- 建议定期备份和清理

### 3. 照片管理

- 文件名包含时间戳，不会覆盖
- 同一身份证多次上传会生成多个文件
- 数据库只保存最新路径

---

## 🐛 已知问题

### 无

目前未发现问题。

---

## 🔮 后续计划

### 可能的改进

- [ ] 照片压缩优化
- [ ] 照片查看界面
- [ ] 照片批量导出
- [ ] 照片清理工具
- [ ] 照片云存储支持

---

## 📈 统计信息

### 代码统计

| 项目 | 数量 |
|------|------|
| 新增函数 | 1 |
| 修改函数 | 4 |
| 新增文档 | 3 |
| 代码行数 | +60行 |

### 数据库变更

| 项目 | 数量 |
|------|------|
| 新增字段 | 1 |
| 修改字段 | 0 |
| SQL语句 | 1 |

---

## ✅ 变更确认清单

- [x] 数据库添加 `id_card_photo` 字段
- [x] 实现照片保存功能
- [x] 修改OCR识别流程
- [x] 修改数据库插入语句
- [x] 更新Excel导入逻辑
- [x] 添加界面显示
- [x] 编写使用文档
- [x] 编写SQL脚本
- [x] 测试功能

---

## 📞 技术支持

### 问题排查

1. **照片未保存**：检查身份证号是否有效（18位）
2. **目录不存在**：系统会自动创建 `images/` 目录
3. **数据库错误**：确认已执行SQL添加新列

### 联系方式

查看文档：
- `身份证照片存储功能说明.md`
- `执行步骤.md`

---

**版本**：v2.2.0  
**更新日期**：2025-11-09  
**状态**：✅ 已完成


