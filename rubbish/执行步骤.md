# 身份证照片存储功能 - 执行步骤

## 🎯 快速开始

### Step 1: 执行SQL添加新列

在MySQL数据库中执行以下SQL：

```sql
USE population;

-- 添加新列
ALTER TABLE population 
ADD COLUMN id_card_photo VARCHAR(255) DEFAULT NULL COMMENT '身份证照片存储路径';

-- 验证（查看表结构）
DESCRIBE population;
```

**预期结果**：
```
Field          | Type          | Null | Key | Default | Extra
---------------|---------------|------|-----|---------|-------
...
id_card_photo  | varchar(255)  | YES  |     | NULL    |
```

### Step 2: 确认images目录

系统会自动创建 `images/` 目录，但您也可以手动创建：

```bash
cd C:\Users\TTYYNX\Desktop\database_lab
mkdir images
```

### Step 3: 启动系统

```bash
streamlit run id_card_app.py
```

### Step 4: 测试功能

1. 在侧边栏输入数据来源代号（如：YY）
2. 切换到"身份证OCR识别"标签页
3. 上传一张身份证照片
4. 点击"开始识别"
5. 查看结果中是否显示：
   ```
   📸 身份证照片已保存至：images/身份证号_时间戳.jpg
   ```
6. 确认保存到数据库
7. 检查 `images/` 目录，应该有对应的照片文件

### Step 5: 验证数据库

```sql
-- 查询刚才保存的记录
SELECT id_no, name, id_card_photo 
FROM population 
WHERE id_card_photo IS NOT NULL
ORDER BY processed_at DESC
LIMIT 1;
```

**预期结果**：
```
id_no               | name | id_card_photo
--------------------|------|----------------------------------
110101199001011234  | 张三  | images/110101199001011234_20251109_153045.jpg
```

---

## ✅ 完成！

现在系统已经支持身份证照片自动保存功能。

### 核心变更

1. ✅ 数据库新增 `id_card_photo` 字段
2. ✅ OCR识别时自动保存照片到 `images/` 目录
3. ✅ 照片路径记录到数据库
4. ✅ Excel导入不受影响（`id_card_photo` 为 NULL）

### 文件结构

```
database_lab/
├── images/                              ⭐ 新增目录
│   ├── 110101199001011234_20251109_153045.jpg
│   └── 310101198505152345_20251109_153120.jpg
├── id_card_app.py                       ✏️ 已修改
├── OCR/
│   ├── add_photo_column.sql             ⭐ 新增
│   ├── 身份证照片存储功能说明.md          ⭐ 新增
│   └── 执行步骤.md                      ⭐ 本文件
└── ...
```

---

## 📝 注意事项

1. **数据库变更**：确保先执行SQL添加新列
2. **目录权限**：确保应用有权限创建 `images/` 目录
3. **照片格式**：自动保存为JPEG格式，质量95
4. **Excel导入**：不受影响，`id_card_photo` 自动为 NULL
5. **旧数据**：现有数据的 `id_card_photo` 字段自动为 NULL

---

## 🔍 快速测试

### 测试OCR识别（含照片保存）

```bash
# 1. 启动系统
streamlit run id_card_app.py

# 2. 上传身份证照片并识别

# 3. 检查images目录
ls -lh images/

# 4. 查询数据库

```

```sql
USE population;
SELECT id_no, name, id_card_photo FROM population WHERE id_card_photo IS NOT NULL;
```

### 测试Excel导入（无照片）

```bash
# 1. 上传Excel文件

# 2. 批量导入

# 3. 查询数据库
SELECT id_no, name, id_card_photo FROM population WHERE source = 'YY';
```

**预期结果**：
- OCR导入的记录：`id_card_photo` 有值
- Excel导入的记录：`id_card_photo` 为 NULL

---

## 📞 获取帮助

详细说明请查看：
- `身份证照片存储功能说明.md` - 完整文档
- `add_photo_column.sql` - SQL脚本

---

**版本**：2.2.0  
**更新日期**：2025-11-09


