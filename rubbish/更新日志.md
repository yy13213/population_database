# 更新日志

## 版本 2.1.0 - 2025-11-09

### ✨ 新增功能

#### 数据来源代号（Source字段）⭐

**背景**：为了更好地追溯数据来源和管理录入者，新增了强制输入数据来源代号的功能。

**主要变更**：

1. **Web界面**
   - ✅ 在侧边栏顶部添加"数据输入者信息"区域
   - ✅ 新增"数据来源代号"输入框
   - ✅ 实时显示当前使用的代号
   - ✅ 未输入代号时阻止录入并提示错误
   - ✅ 代号自动保存到session state

2. **命令行界面**
   - ✅ 支持通过命令行参数传入代号
   - ✅ 支持交互式输入代号
   - ✅ 未输入代号时阻止录入

3. **数据处理**
   - ✅ OCR识别：使用用户输入的代号替代固定值'image'
   - ✅ Excel导入：使用用户输入的代号替代固定值'excel'
   - ✅ 所有录入数据的source字段统一使用用户代号

### 📝 修改的文件

| 文件 | 修改内容 | 影响范围 |
|------|---------|---------|
| `id_card_app.py` | 添加侧边栏输入框和验证逻辑 | Web界面 |
| `id_card_ocr.py` | 添加source参数支持 | 命令行 |
| `README.md` | 添加source字段说明 | 文档 |
| `Source字段使用说明.md` | 新增详细说明文档 | 文档 |
| `更新日志.md` | 本文件 | 文档 |

### 🔧 技术细节

#### 1. Web界面实现

**侧边栏输入**：
```python
source_input = st.text_input(
    "数据来源代号",
    value=st.session_state.get('source_code', ''),
    placeholder="请输入您的代号，例如: YY",
    help="此代号将作为source字段写入数据库",
    key="source_input"
)

if source_input:
    st.session_state['source_code'] = source_input
    st.success(f"✅ 当前数据来源：{source_input}")
else:
    st.warning("⚠️ 请先输入数据来源代号")
```

**验证逻辑**：
```python
if 'source_code' not in st.session_state or not st.session_state['source_code']:
    st.error("❌ 请先在侧边栏输入数据来源代号！")
else:
    # 继续处理
```

#### 2. 函数签名变更

**OCR识别**：
```python
# 旧版本
def process_id_card_data(ocr_result, province_data):
    ...
    'source': 'image'
    ...

# 新版本
def process_id_card_data(ocr_result, province_data, source_code):
    ...
    'source': source_code  # 使用传入的代号
    ...
```

**Excel导入**：
```python
# 旧版本
def excel_to_person_data(row):
    ...
    'source': safe_str(row['数据来源']) or 'excel'
    ...

# 新版本
def excel_to_person_data(row, source_code):
    ...
    'source': source_code  # 使用传入的代号
    ...
```

#### 3. 命令行实现

**参数支持**：
```python
if __name__ == '__main__':
    import sys
    
    if len(sys.argv) < 2:
        print("使用方法：")
        print("  python id_card_ocr.py <身份证图片路径> [数据来源代号]")
    else:
        image_path = sys.argv[1]
        source_code = sys.argv[2] if len(sys.argv) > 2 else None
        main(image_path, source_code)
```

**交互式输入**：
```python
def main(image_path, source_code=None):
    if not source_code:
        print("\n❓ 请输入数据来源代号（例如：YY）：")
        source_code = input("数据来源代号：").strip()
        
        if not source_code:
            print("❌ 数据来源代号不能为空")
            return
```

### 📊 数据库影响

**source字段**：
- 类型：VARCHAR(64)
- 用途：记录数据录入者代号
- 旧值：'image'（OCR）或'excel'（批量导入）
- 新值：用户输入的代号（如'YY', 'ZS'等）

**查询示例**：
```sql
-- 查询某个录入者的数据
SELECT * FROM population WHERE source = 'YY';

-- 统计各录入者的数据量
SELECT source, COUNT(*) as count
FROM population
GROUP BY source
ORDER BY count DESC;
```

### 🎯 使用方式变更

#### Web界面

**旧版本**：
1. 打开系统
2. 直接上传身份证或Excel
3. 数据自动保存（source='image'或'excel'）

**新版本**：
1. 打开系统
2. **在侧边栏输入代号（如：YY）** ⭐ 新增
3. 上传身份证或Excel
4. 数据保存（source='YY'）

#### 命令行

**旧版本**：
```bash
python id_card_ocr.py id_card.jpg
```

**新版本（方式1）**：
```bash
python id_card_ocr.py id_card.jpg YY
```

**新版本（方式2）**：
```bash
python id_card_ocr.py id_card.jpg
# 系统会提示输入代号
```

### ⚠️ 重要提示

1. **必填项**：代号现在是必填的，不输入无法录入数据
2. **兼容性**：旧数据的source字段保持不变
3. **建议**：使用2-4个字符的简短代号
4. **追溯**：可通过source字段追溯到具体录入者

### 📝 文档更新

新增文档：
- `Source字段使用说明.md` - 详细使用指南
- `更新日志.md` - 本文件

更新文档：
- `README.md` - 添加source字段说明

### 🐛 已知问题

无

### 🔮 后续计划

可能的改进：
- [ ] 代号管理界面
- [ ] 代号有效性验证
- [ ] 录入统计看板
- [ ] 导出录入报表

---

## 版本 2.0.0 - 2025-11-09

### ✨ 新增功能

#### Excel批量导入

- ✅ Excel模板生成
- ✅ 批量数据解析
- ✅ 数据验证
- ✅ 批量导入数据库
- ✅ Web界面集成

详见：`功能更新说明.md`

---

## 版本 1.0.0 - 2025-11-09

### ✨ 初始版本

#### 身份证OCR识别

- ✅ GPT-4 Vision识别
- ✅ 自动解析身份证号
- ✅ 地址码匹配
- ✅ Web界面
- ✅ 命令行工具

---

## 总结

### 版本历程

```
v1.0.0 (2025-11-09)
  └─ 身份证OCR识别功能
       ↓
v2.0.0 (2025-11-09)
  └─ 添加Excel批量导入
       ↓
v2.1.0 (2025-11-09) ⭐ 当前版本
  └─ 添加数据来源代号（Source字段）
```

### 核心功能

| 功能 | 版本 | 状态 |
|------|------|------|
| 身份证OCR识别 | v1.0.0 | ✅ |
| Excel批量导入 | v2.0.0 | ✅ |
| 数据来源代号 | v2.1.0 | ✅ |

### 技术栈

- Python 3.8+
- Streamlit（Web界面）
- GPT-4 Vision API（OCR）
- Pandas（Excel处理）
- PyMySQL（数据库）

---

**最后更新**：2025-11-09  
**当前版本**：2.1.0  
**状态**：稳定版本

