# 🔍 调试省份显示NaN问题指南

## 快速诊断步骤

### 步骤1：打开浏览器控制台

1. 访问 http://127.0.0.1:6667
2. 按 `F12` 打开开发者工具
3. 切换到 `Console` (控制台) 标签

### 步骤2：查看省份名称映射日志

刷新页面后，查找以下关键日志：

#### 📋 地图省份名称

```
📋 地图中的所有省份名称: Array(34)
```

展开这个数组，查看实际的省份名称格式，例如：
- `"新疆维吾尔自治区"`
- `"广西壮族自治区"`
- `"西藏自治区"`
- `"宁夏回族自治区"`
- `"澳门特别行政区"`

#### 🔧 动态匹配日志

```
🔧 动态匹配省份名称...
   "北京" → "北京市"
   "新疆" → "新疆维吾尔自治区"
   "广西" → "广西壮族自治区"
   ...
```

查看是否所有省份都成功映射。

#### 📌 关键省份检查

```
📌 关键省份映射检查:
   新疆: 新疆维吾尔自治区
   广西: 广西壮族自治区
   西藏: 西藏自治区
   宁夏: 宁夏回族自治区
   内蒙古: 内蒙古自治区
   澳门: 澳门特别行政区
   香港: 香港特别行政区
```

**如果看到 `❌未找到`，说明该省份映射失败！**

### 步骤3：查看数据映射日志

切换到"人口分布"标签后，查找：

```
🗺️ 人口分布图 - 数据映射:
   后端: "新疆" (5000人) → 地图: "新疆维吾尔自治区"
   后端: "广西" (8000人) → 地图: "广西壮族自治区"
   ...
```

检查：
1. 后端数据是否存在
2. 映射后的地图名称是否正确

---

## 常见问题和解决方案

### 问题1：地图名称格式不一致

**症状**：
```
后端: "新疆" → 地图: "新疆"  ❌ 应该是 "新疆维吾尔自治区"
```

**原因**：映射表没有正确更新

**解决方案**：检查 `updateProvinceNameMap` 函数的后缀移除逻辑

---

### 问题2：后端返回的省份名称不在数据中

**症状**：
```
后端数据: { "新疆": 5000, "广西": 8000, ... }
但地图上显示NaN
```

**原因**：后端省份名称与映射表的key不匹配

**解决方案**：
1. 检查后端 `_normalize_province_name` 方法
2. 确认返回的简称是否正确

---

### 问题3：地图数据源的省份名称格式

**可能的格式**：
- 阿里云DataV：`"新疆维吾尔自治区"`、`"广西壮族自治区"`
- 其他数据源：`"新疆"`、`"广西"`

**诊断方法**：
查看控制台的 `📋 地图中的所有省份名称` 日志

---

## 使用调试工具

访问专用调试页面：
```
http://127.0.0.1:6667/static/debug_provinces.html
```

这个工具可以：
1. ✅ 显示地图数据中的所有省份名称
2. ✅ 显示后端API返回的所有省份名称
3. ✅ 生成名称匹配对照表
4. ✅ 自动生成正确的映射代码

### 使用步骤

1. 点击"加载地图数据"按钮
2. 点击"加载API数据"按钮
3. 点击"生成对照表"查看匹配情况
4. 点击"生成代码"获取正确的映射表代码

---

## 手动验证映射

### 测试代码

在浏览器控制台中运行：

```javascript
// 查看当前映射表
console.log('当前映射表:', provinceNameMap);

// 测试特定省份
const testProvinces = ['新疆', '广西', '西藏', '宁夏', '澳门'];
testProvinces.forEach(p => {
    console.log(`${p} → ${normalizeProvinceName(p)}`);
});

// 查看后端数据
console.log('后端人口数据:', allData.population);
```

### 预期结果

```javascript
新疆 → 新疆维吾尔自治区
广西 → 广西壮族自治区
西藏 → 西藏自治区
宁夏 → 宁夏回族自治区
澳门 → 澳门特别行政区
```

---

## 修复方案

### 方案A：检查后缀移除逻辑

确保后缀按正确顺序移除：

```javascript
const suffixes = [
    '维吾尔自治区',    // 最具体的后缀先移除
    '壮族自治区', 
    '回族自治区',
    '自治区',          // 一般的后缀后移除
    '特别行政区',
    '省',
    '市'
];
```

**关键**：使用 `endsWith()` 而不是 `replace()`，确保只移除一次。

### 方案B：手动指定映射

如果自动匹配失败，在 `updateProvinceNameMap` 后添加手动修正：

```javascript
// 手动修正特殊省份
provinceNameMap['新疆'] = '新疆维吾尔自治区';
provinceNameMap['广西'] = '广西壮族自治区';
provinceNameMap['西藏'] = '西藏自治区';
provinceNameMap['宁夏'] = '宁夏回族自治区';
provinceNameMap['澳门'] = '澳门特别行政区';
```

### 方案C：修改后端不简化名称

修改 `GIS/data_statistics.py` 的 `_normalize_province_name` 方法，不进行简化：

```python
def _normalize_province_name(self, name: str) -> str:
    """保持原始省份名称"""
    return name  # 不进行任何处理
```

---

## 实时调试技巧

### 1. 监听数据加载

```javascript
// 在控制台运行
window.addEventListener('load', () => {
    console.log('页面加载完成');
    setTimeout(() => {
        console.log('当前数据:', allData);
        console.log('当前映射:', provinceNameMap);
    }, 3000);
});
```

### 2. 强制刷新缓存

```javascript
// 在控制台运行
fetch('/api/cache/update', { method: 'POST' })
    .then(r => r.json())
    .then(d => console.log('缓存刷新结果:', d));
```

### 3. 检查地图注册

```javascript
// 在控制台运行
const map = echarts.getMap('china');
console.log('地图是否已注册:', !!map);
if (map) {
    console.log('地图GeoJSON:', map.geoJson);
}
```

---

## 报告问题模板

如果问题仍未解决，请提供以下信息：

### 控制台日志

```
复制粘贴以下日志：
1. "📋 地图中的所有省份名称" 的输出
2. "📌 关键省份映射检查" 的输出
3. "🗺️ 人口分布图 - 数据映射" 的输出
4. 任何红色错误信息
```

### 后端数据

```
复制粘贴 /api/data/population 的返回结果
```

### 地图数据源

```
复制粘贴 "✅ 中国地图数据加载成功" 后的数据源信息
```

---

## 快速修复检查清单

- [ ] 刷新页面（Ctrl+F5）
- [ ] 打开控制台（F12）
- [ ] 查看地图省份名称日志
- [ ] 查看映射检查日志
- [ ] 确认没有红色错误
- [ ] 切换到人口分布标签
- [ ] 查看数据映射日志
- [ ] 鼠标悬停查看tooltip
- [ ] 使用调试工具页面

---

## 联系支持

如果以上步骤都无法解决问题，请：

1. 访问调试工具页面生成对照表
2. 截图控制台日志
3. 提供浏览器版本信息
4. 说明具体哪些省份显示NaN

---

**✅ 祝调试顺利！**

