# Excel批量导入功能使用说明

## 📋 功能概述

系统现在支持两种数据录入方式：
1. **身份证OCR识别**：单张身份证照片识别
2. **Excel批量导入**：批量导入人口信息 ⭐ **新功能**

---

## 🚀 快速开始

### Step 1: 安装依赖

```bash
cd OCR
pip install pandas openpyxl
```

或者一次性安装所有依赖：

```bash
pip install -r requirements.txt
```

### Step 2: 生成Excel模板

运行模板生成脚本：

```bash
python generate_excel_template.py
```

这将生成两个文件：
- `population_template.xlsx` - 空白模板（带说明行）
- `population_sample.xlsx` - 测试样例（包含5条示例数据）

### Step 3: 填写Excel文件

打开`population_template.xlsx`，按照以下格式填写：

| 字段 | 是否必填 | 格式示例 | 说明 |
|------|---------|---------|------|
| 身份证号码 | ✅ 必填 | 110101199001011234 | 18位身份证号 |
| 姓名 | ✅ 必填 | 张三 | 真实姓名 |
| 性别 | ✅ 必填 | 男/女 | 只能填"男"或"女" |
| 曾用名 | 可选 | 张小三 | 曾经使用的姓名 |
| 出生年月日 | 可选 | 2000-01-01 | YYYY-MM-DD格式 |
| 民族 | 可选 | 汉族 | 例：汉族、回族 |
| 婚姻状况 | 可选 | 已婚 | 未婚/已婚/离异/丧偶 |
| 受教育程度 | 可选 | 本科 | 未上过学/小学/初中/高中/大专/本科/硕士及以上 |
| 户籍所在地-省 | 可选 | 北京市 | |
| 户籍所在地-市 | 可选 | 市辖区 | |
| 户籍所在地-区 | 可选 | 东城区 | |
| 住房情况 | 可选 | 自有住房 | |
| 现居住地-省 | 可选 | 上海市 | |
| 现居住地-市 | 可选 | 黄浦区 | |
| 现居住地-区 | 可选 | | |
| 户籍登记类型 | 可选 | 家庭户 | 家庭户/集体户 |
| 收入情况(元/月) | 可选 | 8000.50 | 数字格式 |
| 数据来源 | 可选 | excel | 默认为excel |

### Step 4: 上传并导入

1. 打开Web界面：
```bash
streamlit run id_card_app.py
```

2. 切换到"📊 Excel批量导入"标签页

3. 点击"选择Excel文件"，上传填写好的Excel文件

4. 点击"📖 解析Excel文件"

5. 查看数据预览，确认无误后点击"✅ 确认导入"

---

## 📊 Excel模板说明

### 模板结构

```
行1：表头（列名）
行2：说明行（可选，系统会自动跳过）
行3+：数据行
```

### 示例

| 身份证号码 | 姓名 | 曾用名 | 性别 | 出生年月日 | 民族 | ... |
|-----------|------|-------|------|-----------|------|-----|
| 18位身份证号 | 必填 | 可选 | 男/女 | 格式: 2000-01-01 | 例: 汉族 | ... |
| 110101199001011234 | 张三 | | 男 | 1990-01-01 | 汉族 | ... |
| 310101198505152345 | 李四 | 李小四 | 女 | 1985-05-15 | 汉族 | ... |

### 数据验证规则

系统会自动验证以下内容：

1. **身份证号码**
   - 不能为空
   - 必须是18位

2. **姓名**
   - 不能为空

3. **性别**
   - 只能是"男"或"女"

如果验证失败，系统会显示具体的错误信息和行号。

---

## 🎯 测试样例

系统提供了5条测试数据，可以直接用于测试：

```bash
# 使用测试样例
# 打开 population_sample.xlsx 查看格式
# 或直接上传该文件进行测试
```

测试数据包含：
- 不同地区的身份证号
- 各种民族
- 不同的婚姻状况和教育程度
- 完整的地址信息

---

## 💡 使用技巧

### 1. 批量填写

- 使用Excel的填充功能快速填写重复数据
- 使用公式自动生成某些字段
- 使用数据验证限制输入格式

### 2. 数据准备

**身份证号格式**：
- 前6位：地址码
- 7-14位：出生日期（YYYYMMDD）
- 15-17位：顺序码
- 第18位：校验码

**日期格式**：
- 统一使用：YYYY-MM-DD
- 例如：2000-01-01

**地址格式**：
- 省：北京市、上海市、广东省
- 市：市辖区、广州市、杭州市
- 区：东城区、黄浦区、西湖区

### 3. 错误处理

如果导入失败，系统会显示：
- 失败的条数
- 具体的错误信息
- 成功导入的条数

**常见错误**：
- 身份证号已存在：该身份证号已在数据库中
- 身份证号格式错误：长度不是18位
- 性别格式错误：不是"男"或"女"

---

## 📈 批量导入流程图

```
准备Excel文件
    ↓
打开Web界面
    ↓
切换到"Excel批量导入"标签页
    ↓
上传Excel文件
    ↓
点击"解析Excel文件"
    ↓
系统验证数据
    ├─ 验证通过 → 显示数据预览
    └─ 验证失败 → 显示错误信息
         ↓
    修改Excel文件
         ↓
    重新上传
    ↓
确认数据无误
    ↓
点击"确认导入"
    ↓
系统批量插入数据库
    ├─ 显示成功条数
    ├─ 显示失败条数
    └─ 显示错误详情
    ↓
完成！
```

---

## 🔧 高级用法

### 1. 编程方式生成Excel

```python
import pandas as pd

# 创建数据
data = {
    '身份证号码': ['110101199001011234', '310101198505152345'],
    '姓名': ['张三', '李四'],
    '性别': ['男', '女'],
    '民族': ['汉族', '汉族'],
    # ... 其他字段
}

# 生成Excel
df = pd.DataFrame(data)
df.to_excel('my_population_data.xlsx', sheet_name='人口信息表', index=False)
```

### 2. 从其他系统导出

如果您的数据来自其他系统：

1. 导出为CSV或Excel格式
2. 调整列名以匹配模板
3. 检查数据格式
4. 上传到系统

### 3. 数据清洗

导入前建议：
- 删除空行
- 统一日期格式
- 验证身份证号格式
- 检查必填字段

---

## ⚠️ 注意事项

### 1. Excel文件要求

- **格式**：.xlsx 或 .xls
- **工作表名**：必须是"人口信息表"
- **编码**：UTF-8（中文支持）

### 2. 数据要求

- 身份证号不能重复
- 必填字段不能为空
- 日期格式必须正确

### 3. 性能建议

- 单次导入建议不超过1000条
- 大量数据可分批导入
- 导入过程请勿关闭浏览器

### 4. 数据安全

- 确保Excel文件来源可靠
- 导入前备份数据库
- 检查数据的准确性

---

## 🐛 常见问题

### Q1: 提示"Excel文件解析失败"？

**A**: 检查以下几点：
1. 文件格式是否为.xlsx或.xls
2. 工作表名是否为"人口信息表"
3. 表头是否与模板一致
4. 文件是否损坏

### Q2: 部分数据导入失败？

**A**: 查看错误详情：
- 身份证号重复：修改或删除重复项
- 格式错误：按照要求修改数据
- 必填字段为空：补充完整

### Q3: 如何修改已导入的数据？

**A**: 
- 方式1：先删除，再重新导入
- 方式2：在数据库中直接修改（需要权限）

### Q4: 可以导入多少条数据？

**A**: 
- 理论上无限制
- 实际建议单次不超过1000条
- 过多数据请分批导入

### Q5: 空值如何处理？

**A**: 
- 除必填字段外，其他字段可以为空
- 空值会在数据库中保存为NULL

---

## 📝 完整示例

### 示例1：基本用法

1. 生成模板：
```bash
python generate_excel_template.py
```

2. 打开`population_template.xlsx`，填写数据：

| 身份证号码 | 姓名 | 性别 | 民族 |
|-----------|------|------|------|
| 110101199001011234 | 张三 | 男 | 汉族 |
| 310101198505152345 | 李四 | 女 | 汉族 |

3. 保存文件

4. 打开Web界面，上传文件，导入

### 示例2：使用测试样例

```bash
# 1. 生成测试样例
python generate_excel_template.py

# 2. 启动Web界面
streamlit run id_card_app.py

# 3. 上传 population_sample.xlsx
# 4. 点击解析和导入
```

### 示例3：批量生成数据

```python
import pandas as pd
import random

# 批量生成100条测试数据
data = []
for i in range(100):
    person = {
        '身份证号码': f'11010119900101{i:04d}',
        '姓名': f'测试{i}',
        '性别': random.choice(['男', '女']),
        '民族': '汉族',
        # ... 其他字段
    }
    data.append(person)

df = pd.DataFrame(data)
df.to_excel('batch_data.xlsx', sheet_name='人口信息表', index=False)
```

---

## 📞 获取帮助

如有问题：

1. 查看本文档
2. 查看README.md
3. 检查错误提示
4. 联系技术支持

---

**版本**：1.0.0  
**更新日期**：2025-11-09  
**功能状态**：✅ 已完成

