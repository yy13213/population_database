# 身份证照片存储功能说明

## 📋 功能概述

系统现在支持**自动保存身份证照片**功能。当用户通过OCR识别上传身份证照片时，系统会：
1. 将照片保存到 `images/` 目录
2. 文件名格式：`身份证号_存储时间.jpg`
3. 将存储路径记录到数据库的 `id_card_photo` 字段

---

## 🎯 数据库变更

### 新增字段

在 `population` 表中新增一列：

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `id_card_photo` | VARCHAR(255) | NULL | 身份证照片存储路径 |

### 执行SQL

```sql
-- 添加新列
ALTER TABLE population 
ADD COLUMN id_card_photo VARCHAR(255) DEFAULT NULL COMMENT '身份证照片存储路径';

-- 查看表结构（验证）
DESCRIBE population;
```

**注意**：所有现有数据的 `id_card_photo` 字段自动为 `NULL`。

---

## 📸 照片存储规则

### 存储位置

```
项目根目录/
└── images/
    ├── 110101199001011234_20251109_153045.jpg
    ├── 310101198505152345_20251109_153120.jpg
    └── 440106199207203456_20251109_153200.jpg
```

### 文件命名规则

**格式**：`{身份证号}_{存储时间}.jpg`

**示例**：
- 身份证号：`110101199001011234`
- 存储时间：`2025年11月9日 15:30:45`
- 文件名：`110101199001011234_20251109_153045.jpg`

### 时间戳格式

- 格式：`YYYYMMDD_HHMMSS`
- 示例：`20251109_153045` = 2025年11月9日 15:30:45

---

## 🔄 工作流程

### OCR识别流程（含照片保存）

```
用户上传身份证照片
    ↓
系统显示照片预览
    ↓
用户点击"开始识别"
    ↓
GPT-4 Vision识别身份证信息
    ├─ 提取：身份证号、姓名、民族、地址
    └─ 如果身份证号有效（18位）：
        ↓
    保存照片到 images/ 目录
        ├─ 文件名：身份证号_时间戳.jpg
        └─ 获得存储路径
    ↓
将照片路径记录到 person_data
    ↓
显示识别结果
    ├─ 基本信息
    ├─ 户籍信息
    ├─ 现居住地
    └─ 📸 照片已保存至：images/xxx.jpg
    ↓
用户确认保存
    ↓
写入数据库（包含 id_card_photo 字段）
```

### Excel批量导入流程

```
用户上传Excel文件
    ↓
系统解析数据
    ↓
生成 person_data
    └─ id_card_photo = NULL（无照片）
    ↓
批量导入数据库
```

**说明**：Excel导入方式不包含照片，`id_card_photo` 字段为 `NULL`。

---

## 💻 代码实现

### 1. 保存照片函数

```python
def save_id_card_photo(image, id_no):
    """
    保存身份证照片到images目录
    :param image: PIL Image对象
    :param id_no: 身份证号
    :return: 照片存储路径
    """
    # 确保images目录存在
    images_dir = 'images'
    if not os.path.exists(images_dir):
        os.makedirs(images_dir)
    
    # 生成文件名：身份证号_存储时间.jpg
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    filename = f"{id_no}_{timestamp}.jpg"
    filepath = os.path.join(images_dir, filename)
    
    # 保存图片
    image.save(filepath, 'JPEG', quality=95)
    
    # 返回相对路径
    return filepath
```

### 2. OCR识别处理

```python
# OCR识别
ocr_result = recognize_id_card(image_bytes)

# 先获取身份证号，用于保存图片
id_no = ocr_result.get('id_no', '')
if id_no and len(id_no) == 18:
    # 保存身份证照片
    photo_path = save_id_card_photo(image, id_no)
else:
    photo_path = None

# 处理数据（包含照片路径）
person_data = process_id_card_data(ocr_result, province_data, source_code, photo_path)
```

### 3. 数据库插入

```sql
INSERT INTO population 
(id_no, name, ..., id_card_photo)
VALUES 
(%s, %s, ..., %s)
```

---

## 📊 数据查询

### 查询有照片的记录

```sql
SELECT id_no, name, id_card_photo 
FROM population 
WHERE id_card_photo IS NOT NULL;
```

### 统计照片数量

```sql
-- 统计有照片的记录数
SELECT COUNT(*) as 有照片数量
FROM population 
WHERE id_card_photo IS NOT NULL;

-- 统计无照片的记录数
SELECT COUNT(*) as 无照片数量
FROM population 
WHERE id_card_photo IS NULL;
```

### 按数据来源统计

```sql
SELECT 
    source as 数据来源,
    COUNT(*) as 总数,
    SUM(CASE WHEN id_card_photo IS NOT NULL THEN 1 ELSE 0 END) as 有照片,
    SUM(CASE WHEN id_card_photo IS NULL THEN 1 ELSE 0 END) as 无照片
FROM population
GROUP BY source;
```

**示例输出**：
```
数据来源 | 总数 | 有照片 | 无照片
--------|------|--------|--------
YY      | 100  | 50     | 50
excel   | 200  | 0      | 200
```

---

## 🎨 界面显示

### OCR识别结果显示

```
📋 识别结果
=================

基本信息：
- 身份证号码：110101199001011234
- 姓名：张三
- 性别：男
- 出生日期：1990-01-01
- 民族：汉族
- 数据来源：YY

...

📸 身份证照片已保存至：images/110101199001011234_20251109_153045.jpg

📄 查看完整数据（JSON格式）
```

### Excel导入结果

Excel导入的数据不包含照片路径，查询时 `id_card_photo` 为 `NULL`。

---

## 💾 照片文件管理

### 照片质量

- 格式：JPEG
- 质量：95（高质量）
- 自动保持原始分辨率

### 存储空间估算

假设每张身份证照片约 200KB：

| 记录数 | 照片数量 | 存储空间 |
|--------|---------|---------|
| 1,000 | 1,000 | ~200MB |
| 10,000 | 10,000 | ~2GB |
| 100,000 | 100,000 | ~20GB |

### 备份建议

定期备份 `images/` 目录：

```bash
# 压缩备份
tar -czf images_backup_20251109.tar.gz images/

# 或复制到备份位置
cp -r images/ /backup/images_20251109/
```

---

## 🔍 照片查看

### 方式1：通过文件系统

直接打开 `images/` 目录，查看对应的 `.jpg` 文件。

### 方式2：通过数据库查询

```sql
-- 查询某人的照片路径
SELECT id_card_photo FROM population WHERE id_no = '110101199001011234';

-- 结果：images/110101199001011234_20251109_153045.jpg
```

然后打开该文件查看。

### 方式3：编程访问

```python
import pymysql
from PIL import Image

# 查询照片路径
connection = pymysql.connect(**MYSQL_CONFIG)
cursor = connection.cursor()
cursor.execute("SELECT id_card_photo FROM population WHERE id_no = %s", ('110101199001011234',))
photo_path = cursor.fetchone()[0]

# 打开照片
if photo_path:
    image = Image.open(photo_path)
    image.show()
```

---

## ⚠️ 注意事项

### 1. 目录权限

确保应用程序有权限在项目根目录创建 `images/` 目录并写入文件。

### 2. 重复照片

如果同一身份证号多次上传，系统会生成不同的文件名（时间戳不同），不会覆盖旧照片。

**示例**：
```
images/110101199001011234_20251109_153045.jpg  (第一次上传)
images/110101199001011234_20251109_160530.jpg  (第二次上传)
```

数据库中只保存最新的路径。

### 3. 照片删除

如果删除数据库记录，照片文件不会自动删除，需要手动清理。

**清理脚本示例**：
```python
import os
import pymysql

# 获取数据库中所有照片路径
connection = pymysql.connect(**MYSQL_CONFIG)
cursor = connection.cursor()
cursor.execute("SELECT id_card_photo FROM population WHERE id_card_photo IS NOT NULL")
db_photos = set(row[0] for row in cursor.fetchall())

# 扫描images目录
all_photos = set(os.path.join('images', f) for f in os.listdir('images') if f.endswith('.jpg'))

# 找出未使用的照片
unused_photos = all_photos - db_photos

# 删除未使用的照片
for photo in unused_photos:
    os.remove(photo)
    print(f"已删除：{photo}")
```

### 4. 数据迁移

如果迁移数据库到其他服务器：
1. 导出数据库
2. 同时复制 `images/` 目录
3. 确保路径一致

---

## 🆕 与旧版本的区别

### 旧版本（v2.1）

- ❌ 不保存身份证照片
- ❌ 数据库无照片路径字段
- ❌ 无法追溯原始照片

### 新版本（v2.2）

- ✅ 自动保存身份证照片到 `images/` 目录
- ✅ 数据库记录照片存储路径
- ✅ 可随时查看原始照片
- ✅ 文件名包含时间戳，便于管理

---

## 📝 使用示例

### 示例1：OCR识别（含照片保存）

```
1. 打开系统
   $ streamlit run id_card_app.py

2. 输入数据来源代号：YY

3. 切换到"身份证OCR识别"标签页

4. 上传身份证照片

5. 点击"开始识别"

6. 查看识别结果：
   ✅ 识别成功！照片已保存
   📸 身份证照片已保存至：images/110101199001011234_20251109_153045.jpg

7. 确认保存到数据库

8. 数据库记录：
   id_no: 110101199001011234
   name: 张三
   id_card_photo: images/110101199001011234_20251109_153045.jpg
```

### 示例2：查询照片

```sql
-- 查询张三的记录
SELECT * FROM population WHERE name = '张三';

-- 结果包含照片路径
id_card_photo: images/110101199001011234_20251109_153045.jpg

-- 打开文件查看照片
```

---

## 🔧 故障排除

### 问题1：照片未保存

**症状**：`id_card_photo` 字段为 `NULL`

**可能原因**：
1. 身份证号识别失败（不是18位）
2. images目录权限不足
3. 磁盘空间不足

**解决方案**：
1. 检查识别结果中的身份证号是否正确
2. 确保有权限创建目录和写入文件
3. 检查磁盘空间

### 问题2：无法访问照片

**症状**：数据库中有路径，但打不开文件

**可能原因**：
1. 文件被移动或删除
2. 路径不正确
3. 权限问题

**解决方案**：
1. 检查 `images/` 目录中是否存在该文件
2. 验证数据库中的路径是否正确
3. 检查文件权限

### 问题3：images目录不存在

**症状**：保存照片时出错

**解决方案**：
系统会自动创建 `images/` 目录，如果仍然出错，手动创建：

```bash
mkdir images
chmod 755 images
```

---

## 📈 最佳实践

### 1. 定期备份

```bash
# 每周备份一次
tar -czf images_backup_$(date +%Y%m%d).tar.gz images/
```

### 2. 照片压缩

如果存储空间有限，可以降低照片质量：

```python
# 在 save_id_card_photo 函数中
image.save(filepath, 'JPEG', quality=85)  # 降低质量到85
```

### 3. 照片审计

定期检查未使用的照片并清理：

```python
# 使用清理脚本（见上文"注意事项"）
python clean_unused_photos.py
```

---

## ✅ 总结

- 📸 **自动保存**：OCR识别时自动保存照片
- 📝 **数据库记录**：照片路径记录在 `id_card_photo` 字段
- 📁 **统一管理**：所有照片存储在 `images/` 目录
- 🏷️ **规范命名**：身份证号_时间戳.jpg
- 🔍 **可追溯**：随时查看原始照片

---

**版本**：2.2.0  
**更新日期**：2025-11-09  
**功能状态**：✅ 已完成


