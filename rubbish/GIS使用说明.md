# 📖 中国人口GIS可视化系统 - 详细使用说明

## 目录

1. [系统简介](#系统简介)
2. [环境准备](#环境准备)
3. [安装步骤](#安装步骤)
4. [功能详解](#功能详解)
5. [操作指南](#操作指南)
6. [高级使用](#高级使用)
7. [常见问题](#常见问题)
8. [最佳实践](#最佳实践)

---

## 系统简介

### 📊 系统概述

中国人口GIS可视化系统是一个基于Python开发的地理信息可视化平台，用于展示和分析中国各省份的人口数据。

### ✨ 核心功能

| 功能模块 | 说明 | 用途 |
|---------|------|------|
| 📈 数据统计 | 从数据库读取并统计分析 | 获取各维度统计数据 |
| 🗺️ 地图可视化 | 基于PyEcharts的交互式地图 | 地理分布可视化 |
| 💻 Web界面 | Streamlit构建的现代化界面 | 用户交互和数据展示 |
| 📥 数据导出 | CSV格式数据下载 | 数据报告和二次分析 |

### 🎯 适用场景

- **政府部门**：人口统计、政策制定
- **研究机构**：人口分析、学术研究
- **企业决策**：市场分析、选址规划
- **教育培训**：地理教学、数据可视化教学

---

## 环境准备

### 💻 系统要求

| 项目 | 要求 |
|------|------|
| 操作系统 | Windows / macOS / Linux |
| Python版本 | 3.8 及以上 |
| 内存 | 至少 4GB |
| 磁盘空间 | 至少 500MB |
| 网络 | 需要连接数据库 |

### 📦 依赖软件

```bash
# Python 3.8+
python --version

# pip 包管理器
pip --version

# MySQL数据库（已有远程数据库则不需要）
```

---

## 安装步骤

### Step 1: 克隆或下载项目

```bash
# 假设项目在 database_lab 目录下
cd database_lab/GIS
```

### Step 2: 安装Python依赖

```bash
# 安装所有依赖
pip install -r requirements.txt

# 或逐个安装
pip install pymysql pandas numpy pyecharts streamlit
```

### Step 3: 验证安装

```bash
# 测试Python模块
python -c "import pymysql, pandas, pyecharts, streamlit; print('✅ 所有依赖安装成功')"
```

**预期输出**：
```
✅ 所有依赖安装成功
```

### Step 4: 准备省份数据

确保项目根目录有 `province_data.json` 文件：

```bash
# 检查文件
ls ../province_data.json

# 或在Windows上
dir ..\province_data.json
```

### Step 5: 配置数据库连接

编辑 `data_statistics.py` 文件：

```python
MYSQL_CONFIG = {
    'host': '你的数据库地址',      # 修改为实际地址
    'port': 18009,                 # 修改为实际端口
    'user': 'root',                # 修改为实际用户名
    'password': 'your_password',   # 修改为实际密码
    'database': 'population',
    'charset': 'utf8mb4'
}
```

### Step 6: 测试数据连接

```bash
python data_statistics.py
```

**预期输出**：
```
============================================================
📊 人口统计数据测试
============================================================

1️⃣ 各省人口数量（前10）:
   1. 广东    :   45,123 人
   2. 山东    :   38,456 人
   ...

✅ 测试完成！
```

如果看到以上输出，说明安装成功！

---

## 功能详解

### 1️⃣ 概览统计

**路径**：Web界面 → 📈 概览统计

**功能**：
- 总人口数统计
- 省级行政区数量
- 已婚人口统计
- 迁移流向统计

**数据卡片**：
```
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ 📊 总人口数  │ │ 🗺️ 省级行政区│ │ 💑 已婚人口  │ │ 🚀 迁移流向  │
│  1,234,567  │ │     34      │ │   123,456   │ │    5,678    │
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
```

**排行榜**：
- 人口数量TOP10
- 人口密度TOP10
- 主要迁入地TOP10
- 主要迁出地TOP10

---

### 2️⃣ 人口分布图

**路径**：Web界面 → 🗺️ 人口分布图

**功能**：
- 中国地图展示各省人口
- 颜色深浅表示人口多少
- 鼠标悬停查看具体数据

**操作**：
- 🖱️ **鼠标悬停**：显示省份名称和人口数
- 🔍 **鼠标滚轮**：缩放地图
- 🖐️ **鼠标拖动**：移动地图

**颜色说明**：
- 🟦 浅蓝色：人口较少
- 🟨 黄色：人口中等
- 🟧 橙色：人口较多
- 🟥 红色：人口很多

**示例数据**：
```
广东省: 45,123 人
山东省: 38,456 人
河南省: 35,789 人
```

---

### 3️⃣ 人口密度图

**路径**：Web界面 → 📍 人口密度图

**功能**：
- 展示各省人口密度（人/km²）
- 基于省份面积计算
- 颜色渐变展示密度差异

**计算公式**：
```
人口密度 = 人口数量 / 省份面积（km²）
```

**密度等级**：
- 🟢 0-50 人/km²：低密度
- 🟡 50-200 人/km²：中密度
- 🟠 200-500 人/km²：高密度
- 🔴 500+ 人/km²：超高密度

**典型数据**：
| 省份 | 人口数 | 面积(km²) | 密度 |
|------|--------|-----------|------|
| 上海 | 10,000 | 6,340 | 1,577.29 |
| 北京 | 8,500 | 16,410 | 518.04 |
| 广东 | 45,123 | 179,800 | 250.99 |

---

### 4️⃣ 结婚人口图

**路径**：Web界面 → 💑 结婚人口图

**功能**：
- 展示各省结婚人口分布
- 计算结婚率
- 显示详细婚姻统计

**统计指标**：
- **已婚人数**：在婚姻记录中的人数
- **结婚率**：已婚人数 / 总人口 × 100%
- **总人口**：该省总人口数

**悬停信息示例**：
```
广东省
结婚人数: 1,000 人
结婚率: 2.21%
总人口: 45,123 人
```

**数据表格**：
| 省份 | 已婚人数 | 结婚率(%) | 总人口 |
|------|---------|-----------|--------|
| 广东 | 1,000 | 2.21 | 45,123 |
| 山东 | 850 | 2.21 | 38,456 |

---

### 5️⃣ 人口迁移图

**路径**：Web界面 → 🚀 人口迁移图

**功能**：
- 展示人口迁移流向
- 从户籍地到现居住地
- 箭头表示迁移方向
- 线宽表示迁移人数

**视觉元素**：
- 🔵 **蓝点**：省份标记
- ➡️ **箭头**：迁移方向
- 📏 **线宽**：迁移人数（越粗越多）
- 🌊 **动画**：流动效果

**数据示例**：
```
四川 → 广东: 500 人
河南 → 北京: 450 人
安徽 → 上海: 380 人
```

**迁移表格**：
| 排名 | 迁出地 | 迁入地 | 人数 |
|------|--------|--------|------|
| 1 | 四川 | 广东 | 500 |
| 2 | 河南 | 北京 | 450 |
| 3 | 安徽 | 上海 | 380 |

---

### 6️⃣ 性别比例分析

**路径**：Web界面 → 👫 性别比例分析

**功能**：
- 各省男女人口对比
- 性别比计算
- 堆叠柱状图展示

**图表类型**：堆叠柱状图
- 🔵 蓝色：男性人口
- 🔴 红色：女性人口

**性别比计算**：
```
性别比 = (男性人口 / 女性人口) × 100
```

**正常范围**：103-107

**数据表格**：
| 省份 | 男性 | 女性 | 性别比 |
|------|------|------|--------|
| 广东 | 23,000 | 22,123 | 103.96 |
| 山东 | 19,500 | 18,956 | 102.87 |

---

### 7️⃣ 年龄分布分析

**路径**：Web界面 → 🎂 年龄分布分析

**功能**：
- 年龄段人口统计
- 饼图展示占比
- 支持省份选择

**年龄段划分**：
- 👶 **0-18岁**：未成年人
- 👨 **18-35岁**：青年
- 👨‍💼 **35-60岁**：中年
- 👴 **60岁以上**：老年人

**省份选择**：
```
下拉菜单: [全国] [北京] [上海] [广东] ...
```

**图表示例**：
```
广东省年龄分布
┌─────────────────┐
│   0-18岁: 11%   │
│  18-35岁: 33%   │
│  35-60岁: 44%   │
│   60+岁: 12%    │
└─────────────────┘
```

---

### 8️⃣ 民族分布分析

**路径**：Web界面 → 🌈 民族分布分析

**功能**：
- 各省民族构成
- 饼图展示占比
- 支持省份选择

**省份选择**：
```
下拉菜单: [北京] [上海] [广东] ...
```

**民族数据示例**：
| 民族 | 人口数 | 占比 |
|------|--------|------|
| 汉族 | 41,000 | 90.9% |
| 壮族 | 2,000 | 4.4% |
| 回族 | 1,500 | 3.3% |
| 其他 | 623 | 1.4% |

---

### 9️⃣ 数据表格

**路径**：Web界面 → 📊 数据表格

**功能**：
- 查看原始数据
- 数据排序
- CSV导出

**标签页**：
1. **人口统计**：省份、人口数、密度
2. **婚姻统计**：省份、已婚人数、结婚率、总人口
3. **性别统计**：省份、男性、女性、性别比
4. **年龄统计**：省份、各年龄段人口

**数据导出**：
每个标签页都有 `📥 下载数据` 按钮
- 点击下载CSV文件
- 文件名：`population_stats.csv`、`marriage_stats.csv` 等
- 编码：UTF-8 with BOM（Excel兼容）

---

## 操作指南

### 🚀 启动系统

#### 方式1：Streamlit Web界面（推荐）

```bash
# 进入GIS目录
cd GIS

# 启动Web应用
streamlit run app.py
```

**效果**：
- 自动打开浏览器
- 访问地址：`http://localhost:8501`
- 看到系统主界面

#### 方式2：生成静态HTML

```bash
# 创建输出目录
mkdir output

# 生成所有地图
python gis_visualize.py
```

**输出文件**：
```
output/
├── population_map.html      (人口分布图)
├── density_map.html         (人口密度图)
├── marriage_map.html        (结婚人口图)
├── migration_map.html       (人口迁移图)
└── comprehensive.html       (综合统计)
```

**使用**：双击HTML文件用浏览器打开

---

### 📖 使用流程

#### 完整工作流程

```
1. 启动系统
   ↓
2. 查看概览统计（了解整体情况）
   ↓
3. 选择具体可视化类型
   ↓
4. 鼠标交互查看详情
   ↓
5. 导出需要的数据
   ↓
6. 关闭系统
```

#### 典型操作示例

**场景1：分析广东省人口状况**

```
Step 1: 启动系统
   streamlit run app.py

Step 2: 查看人口分布图
   侧边栏 → 选择"🗺️ 人口分布图"
   鼠标悬停在广东省

Step 3: 查看人口密度
   侧边栏 → 选择"📍 人口密度图"
   对比广东与其他省份

Step 4: 查看年龄分布
   侧边栏 → 选择"🎂 年龄分布分析"
   下拉菜单 → 选择"广东"

Step 5: 导出数据
   侧边栏 → 选择"📊 数据表格"
   点击"📥 下载数据"
```

**场景2：研究人口迁移流向**

```
Step 1: 查看迁移地图
   侧边栏 → 选择"🚀 人口迁移图"
   观察箭头流向

Step 2: 查看详细数据
   滚动到页面下方
   查看"📊 主要迁移流向"表格

Step 3: 分析迁入地
   侧边栏 → 选择"📈 概览统计"
   查看"🚀 主要迁入地TOP10"

Step 4: 分析迁出地
   查看"🚀 主要迁出地TOP10"
```

---

### 🖱️ 地图交互

#### 鼠标操作

| 操作 | 功能 |
|------|------|
| 鼠标悬停 | 显示详细信息 |
| 鼠标滚轮向上 | 放大地图 |
| 鼠标滚轮向下 | 缩小地图 |
| 鼠标拖动 | 移动地图 |
| 双击 | 重置视图 |

#### 工具栏

地图右上角工具栏：
- 💾 **保存为图片**：下载PNG格式
- 🔄 **刷新**：重置地图
- 🔍 **放大/缩小**：缩放控制

---

## 高级使用

### 🔧 自定义配置

#### 1. 修改地图主题

编辑 `app.py` 或 `gis_visualize.py`：

```python
from pyecharts.globals import ThemeType

# 浅色主题（默认）
vis = GISVisualization(theme=ThemeType.LIGHT)

# 深色主题
vis = GISVisualization(theme=ThemeType.DARK)

# Chalk主题（粉笔画风格）
vis = GISVisualization(theme=ThemeType.CHALK)

# Essos主题
vis = GISVisualization(theme=ThemeType.ESSOS)
```

#### 2. 调整缓存时间

编辑 `app.py`：

```python
# 默认缓存1小时
@st.cache_data(ttl=3600)

# 缓存30分钟（数据更新频繁时）
@st.cache_data(ttl=1800)

# 缓存4小时（数据稳定时）
@st.cache_data(ttl=14400)

# 禁用缓存（开发调试时）
@st.cache_data(ttl=0)
```

#### 3. 修改地图尺寸

编辑 `gis_visualize.py`：

```python
Map(init_opts=opts.InitOpts(
    width="1400px",    # 修改宽度
    height="800px"     # 修改高度
))
```

---

### 📊 数据二次分析

#### 导出数据后的处理

**使用Excel**：
```
1. 打开下载的CSV文件
2. 另存为 .xlsx 格式
3. 创建数据透视表
4. 制作自定义图表
```

**使用Python**：
```python
import pandas as pd

# 读取导出的CSV
df = pd.read_csv('population_stats.csv')

# 数据分析
top_5 = df.nlargest(5, '人口数')
print(top_5)

# 创建自定义图表
import matplotlib.pyplot as plt
plt.bar(df['省份'], df['人口数'])
plt.show()
```

---

### 🔍 SQL查询扩展

#### 自定义统计查询

编辑 `data_statistics.py`，添加新方法：

```python
def get_custom_statistics(self):
    """自定义统计"""
    self.connect()
    cursor = self.connection.cursor()
    
    # 你的SQL查询
    query = """
        SELECT 
            hukou_province,
            AVG(income) as avg_income
        FROM population
        WHERE income IS NOT NULL
        GROUP BY hukou_province
    """
    
    cursor.execute(query)
    results = cursor.fetchall()
    cursor.close()
    
    return dict(results)
```

#### 在Web界面中使用

编辑 `app.py`，添加新功能：

```python
# 获取自定义统计
custom_data = stats.get_custom_statistics()

# 显示在界面
st.subheader("📊 自定义统计")
st.dataframe(pd.DataFrame(custom_data.items(), columns=['省份', '平均收入']))
```

---

## 常见问题

### ❓ 问题1：安装依赖时报错

**错误信息**：
```
ERROR: Could not find a version that satisfies the requirement ...
```

**解决方案**：
```bash
# 升级pip
python -m pip install --upgrade pip

# 使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 或逐个安装
pip install pymysql -i https://pypi.tuna.tsinghua.edu.cn/simple
```

---

### ❓ 问题2：数据库连接超时

**错误信息**：
```
pymysql.err.OperationalError: (2003, "Can't connect to MySQL server...")
```

**检查清单**：
1. ✅ 数据库地址是否正确
2. ✅ 端口号是否正确
3. ✅ 用户名密码是否正确
4. ✅ 网络是否连通
5. ✅ 防火墙是否阻止

**解决方案**：
```bash
# 测试网络连通性


# 测试端口


# 增加超时时间
MYSQL_CONFIG = {
    ...
    'connect_timeout': 60,  # 增加到60秒
    'read_timeout': 60,
    'write_timeout': 60
}
```

---

### ❓ 问题3：地图不显示数据

**现象**：地图显示但没有数据

**原因**：
1. 数据库没有数据
2. 省份名称不匹配
3. 查询结果为空

**解决方案**：
```bash
# 1. 测试数据统计
python data_statistics.py

# 2. 检查数据库

> USE population;
> SELECT COUNT(*) FROM population;
> SELECT DISTINCT hukou_province FROM population LIMIT 10;

# 3. 检查省份名称规范化
# 确保数据库中的省份名称包含"省"、"市"等
```

---

### ❓ 问题4：Streamlit启动失败

**错误信息**：
```
streamlit: command not found
```

**解决方案**：
```bash
# 检查Streamlit是否安装
pip list | grep streamlit

# 重新安装
pip install streamlit

# 或使用完整路径
python -m streamlit run app.py
```

---

### ❓ 问题5：页面加载很慢

**原因**：
- 数据量大
- 数据库查询慢
- 缓存失效

**优化方案**：

**1. 数据库优化**：
```sql
-- 添加索引
CREATE INDEX idx_hukou_province ON population(hukou_province);
CREATE INDEX idx_cur_province ON population(cur_province);
CREATE INDEX idx_gender ON population(gender);
```

**2. 调整缓存**：
```python
# 延长缓存时间
@st.cache_data(ttl=7200)  # 2小时
```

**3. 减少数据量**：
```python
# 只统计部分数据
def get_province_population(self, limit=None):
    query = """
        SELECT hukou_province, COUNT(*) as count
        FROM population
        WHERE hukou_province IS NOT NULL
        GROUP BY hukou_province
    """
    if limit:
        query += f" LIMIT {limit}"
```

---

### ❓ 问题6：导出的CSV乱码

**现象**：Excel打开CSV文件中文显示乱码

**原因**：编码问题

**解决方案**：

**方法1：使用Excel导入功能**
```
1. 打开Excel
2. 数据 → 获取数据 → 从文本/CSV
3. 选择文件
4. 文件原点 → 选择 "65001: Unicode (UTF-8)"
5. 加载
```

**方法2：修改代码**
```python
# app.py 中修改导出代码
csv = df.to_csv(index=False, encoding='utf-8-sig')  # 使用UTF-8 BOM
```

---

## 最佳实践

### 💡 使用建议

#### 1. 数据准备
- ✅ 确保数据库数据完整
- ✅ 省份名称规范统一
- ✅ 定期更新数据

#### 2. 性能优化
- ✅ 添加数据库索引
- ✅ 使用缓存机制
- ✅ 适当控制数据量

#### 3. 可视化设计
- ✅ 选择合适的颜色主题
- ✅ 调整合适的地图尺寸
- ✅ 添加必要的说明文字

#### 4. 数据分析
- ✅ 结合多个维度分析
- ✅ 导出数据做深度分析
- ✅ 定期生成分析报告

---

### 📈 工作流程推荐

**日常使用**：
```
1. 早上打开系统查看概览
2. 关注重点省份变化
3. 导出需要的数据
4. 关闭系统
```

**深度分析**：
```
1. 明确分析目标
2. 查看相关可视化
3. 导出多维度数据
4. 使用Excel/Python深度分析
5. 生成分析报告
```

**报告制作**：
```
1. 生成静态HTML地图
2. 截图保存关键图表
3. 导出数据表格
4. 整理成报告文档
5. 分享给相关人员
```

---

### 🎯 常见场景示例

#### 场景1：月度人口统计报告

```bash
# 1. 启动系统
streamlit run app.py

# 2. 查看概览统计（截图）
# 3. 查看人口分布图（截图）
# 4. 导出人口统计表（CSV）

# 5. 生成静态报告
python gis_visualize.py

# 6. 整理成报告
# - 概览统计截图
# - 人口分布地图
# - 数据表格
# - 分析结论
```

#### 场景2：人口迁移研究

```bash
# 1. 查看迁移地图
streamlit run app.py → 选择"人口迁移图"

# 2. 分析主要流向
查看迁入地TOP10
查看迁出地TOP10

# 3. 导出迁移数据
数据表格 → 下载

# 4. 深度分析
使用Python/Excel分析迁移模式
识别迁移规律
```

#### 场景3：区域对比分析

```bash
# 1. 选择对比省份（如：广东 vs 浙江）

# 2. 对比人口数量
人口分布图 → 悬停查看

# 3. 对比人口密度
人口密度图 → 悬停查看

# 4. 对比年龄结构
年龄分布 → 切换省份对比

# 5. 对比性别比
性别比例 → 查看图表和表格

# 6. 生成对比报告
```

---

### 🔒 数据安全

#### 建议
- ✅ 定期备份数据库
- ✅ 不要公开数据库密码
- ✅ 限制数据访问权限
- ✅ 导出的数据妥善保管

#### 配置安全
```python
# 不要把密码写在代码里
import os

MYSQL_CONFIG = {
    'host': os.getenv('DB_HOST', '127.0.0.1'),
    'port': int(os.getenv('DB_PORT', 3306)),
    'user': os.getenv('DB_USER', 'root'),
    'password': os.getenv('DB_PASSWORD', ''),
    'database': 'population'
}
```

---

## 🆘 获取帮助

### 文档资源
- `README.md` - 项目概览
- `使用说明.md` - 本文档
- 代码注释 - 详细的函数说明

### 自助排查
1. 查看错误信息
2. 参考常见问题
3. 检查配置是否正确
4. 测试数据连接

---

## 🎊 总结

通过本使用说明，您应该能够：
- ✅ 成功安装和配置系统
- ✅ 熟练使用各项功能
- ✅ 进行数据分析和可视化
- ✅ 导出和处理数据
- ✅ 解决常见问题

**祝您使用愉快！** 🎉

