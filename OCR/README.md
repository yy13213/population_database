# 人口信息录入系统

## 📋 系统简介

本系统提供两种数据录入方式：
1. **身份证OCR识别**：使用GPT-4 Vision API识别身份证照片
2. **Excel批量导入**：批量导入人口信息 ⭐ **新功能**

### ✨ 主要功能

#### 方式1：身份证OCR识别
- 🔍 **智能识别**：使用GPT-4 Vision识别身份证上的所有信息
- 📊 **自动解析**：从身份证号自动解析性别、出生日期、户籍地址
- 🗺️ **地址匹配**：根据地址码自动匹配省市区信息
- 💾 **数据入库**：征得用户同意后存入MySQL数据库

#### 方式2：Excel批量导入 ⭐
- 📄 **模板下载**：自动生成标准Excel模板
- 📊 **批量上传**：一次导入多条人口信息
- ✅ **数据验证**：自动验证必填字段和格式
- 📈 **导入统计**：显示成功和失败的条数

#### 共同特性
- 🎨 **友好界面**：统一的Web界面，标签页切换
- 🔒 **数据安全**：完整的错误处理和数据验证
- 📝 **详细日志**：记录所有操作和错误信息

## 🚀 快速开始

### 0. ⚠️ 重要：数据来源代号

**新增要求**：录入数据前必须输入**数据来源代号**（source字段）

- **Web界面**：在左侧边栏输入您的代号（如：YY）
- **命令行**：作为第二个参数传入（如：`python id_card_ocr.py img.jpg YY`）

详细说明请查看：[Source字段使用说明.md](Source字段使用说明.md)

### 1. 安装依赖

```bash
cd OCR
pip install -r requirements.txt
```

### 2. 准备数据

确保`province_data.json`文件在父目录中（已自动生成）

### 3. 生成Excel模板（仅Excel导入需要）

```bash
python generate_excel_template.py
```

这将生成：
- `population_template.xlsx` - 空白模板
- `population_sample.xlsx` - 测试样例（5条数据）

### 4. 使用方式

#### 方式A：Web界面（推荐）⭐

```bash
streamlit run id_card_app.py
```

然后在浏览器中打开显示的URL（通常是 http://localhost:8501）

**功能**：
- 标签页1：身份证OCR识别
- 标签页2：Excel批量导入

#### 方式B：命令行（仅OCR识别）

```bash
python id_card_ocr.py <身份证图片路径>
```

示例：
```bash
python id_card_ocr.py ../身份证.png
```

## 📝 使用流程

### 流程1：身份证OCR识别

```
上传身份证照片
    ↓
GPT-4 Vision识别
    ↓
提取：身份证号、姓名、民族、地址
    ↓
算法解析身份证号
    ├─ 前6位 → 户籍地址（省市区）
    ├─ 第7-14位 → 出生日期
    └─ 第17位 → 性别（奇数=男，偶数=女）
    ↓
匹配地址码到具体省市区
    ↓
显示完整信息
    ↓
用户确认
    ↓
保存到数据库
```

### 流程2：Excel批量导入 ⭐

```
生成/下载Excel模板
    ↓
填写人口信息
    ├─ 身份证号码（必填）
    ├─ 姓名（必填）
    ├─ 性别（必填）
    └─ 其他字段（可选）
    ↓
上传Excel文件
    ↓
系统解析文件
    ↓
数据验证
    ├─ 验证通过 → 显示数据预览
    └─ 验证失败 → 显示错误信息
    ↓
用户确认
    ↓
批量保存到数据库
    ↓
显示导入结果
    ├─ 成功条数
    ├─ 失败条数
    └─ 错误详情
```

## 📊 数据字段说明

| 字段 | 来源 | 说明 |
|------|------|------|
| id_no | OCR识别 | 18位身份证号码 |
| name | OCR识别 | 姓名 |
| gender | 身份证号解析 | 从第17位解析（奇数=男，偶数=女） |
| birth_date | 身份证号解析 | 从第7-14位解析 |
| ethnicity | OCR识别 | 民族 |
| hukou_province/city/district | 地址码匹配 | 从前6位地址码匹配 |
| cur_province/city/district | OCR识别+解析 | 从身份证地址字段解析 |
| processed_at | 系统生成 | 当前时间 |
| source | 固定值 | "image" |
| 其他字段 | 留空 | former_name, marital_status等 |

## 🎯 身份证号解析规则

### 身份证号结构

```
身份证号：110101 19900101 123 4
         ^^^^^^ ^^^^^^^^ ^^^ ^
           |       |      |  └─ 校验码
           |       |      └──── 顺序码（奇数=男，偶数=女）
           |       └─────────── 出生日期（YYYYMMDD）
           └─────────────────── 地址码（6位）
```

### 示例

**身份证号**：`110101199001011234`

**解析结果**：
- 地址码：`110101` → 北京市市辖区东城区
- 出生日期：`19900101` → 1990-01-01
- 性别：`3`（奇数） → 男

## 🖼️ 使用示例

### Web界面使用

1. **启动应用**
```bash
streamlit run id_card_app.py
```

2. **上传照片**
   - 点击"选择身份证图片"
   - 选择PNG或JPG格式的身份证照片

3. **识别信息**
   - 点击"开始识别"按钮
   - 等待几秒钟，AI将识别身份证信息

4. **核对信息**
   - 查看识别的姓名、身份证号、民族等
   - 查看自动解析的性别、出生日期
   - 查看匹配的户籍地址和现居住地

5. **保存数据**
   - 确认信息无误后，点击"确认保存"
   - 系统将数据存入数据库

### 命令行使用

```bash
$ python id_card_ocr.py id_card.jpg

🔍 正在识别身份证...
✅ 身份证识别成功

======================================================================
识别到的身份证信息
======================================================================

📋 基本信息
  身份证号码：110101199001011234
  姓名：张三
  性别：男
  出生日期：1990-01-01
  民族：汉族

🏠 户籍信息（从身份证号前6位解析）
  省份：北京市
  城市：市辖区
  区县：东城区

📍 现居住地（从身份证地址识别）
  省份：北京市
  城市：东城区
  区县：

📅 其他信息
  处理时间：2025-11-09 15:30:00
  数据来源：image

======================================================================

❓ 是否将以上信息保存到数据库？
请输入 yes 确认，或 no 取消：yes

✅ 数据已成功保存到数据库！
```

## ⚙️ 配置说明

### 数据库配置

在代码中修改 `MYSQL_CONFIG`：

```python
MYSQL_CONFIG = {

}
```

### OpenAI API配置

在代码中修改 API 配置：

```python
client = OpenAI(
    base_url="https://api.openai-proxy.org/v1",
    api_key="your-api-key-here"
)
```

## 🔍 技术细节

### 1. OCR识别

使用GPT-4 Vision API进行图像识别：
- 模型：`gpt-4-vision-preview`
- 输入：身份证图片（base64编码）
- 输出：JSON格式的结构化数据

### 2. 地址码匹配

从 `province_data.json` 中匹配地址码：
- 输入：6位地址码（如 `110101`）
- 输出：对应的省市区（如 `北京市-市辖区-东城区`）

### 3. 地址解析

从身份证地址字符串中提取省市区：
- 使用规则匹配省市区关键词
- 处理各种地址格式

### 4. 数据验证

- 身份证号必须是18位
- 自动验证数据完整性
- 防止重复插入（主键约束）

## ⚠️ 注意事项

### 1. 图片质量

- ✅ 清晰的身份证正面照片
- ✅ 光线充足，无反光
- ✅ 文字清晰可见
- ❌ 模糊、反光、倾斜的照片可能识别失败

### 2. 识别准确性

- GPT-4 Vision的识别准确率很高，但不是100%
- **建议**：使用前人工核对识别结果
- 特别注意身份证号的准确性

### 3. API费用

- GPT-4 Vision API按使用量收费
- 每次识别约消耗 0.01-0.02 美元
- 建议控制使用频率

### 4. 隐私保护

- ⚠️ 身份证包含敏感个人信息
- 确保网络安全
- 不要在公共网络上传身份证
- 及时删除上传的图片文件

### 5. 数据库

- 确保population表已创建
- 身份证号为主键，重复插入会失败
- 建议定期备份数据

## 🐛 故障排除

### 问题1：识别失败

**症状**：返回错误或识别结果不正确

**解决方案**：
1. 检查图片质量
2. 确保身份证信息清晰可见
3. 尝试重新拍照或扫描

### 问题2：API连接失败

**症状**：`Connection Error` 或超时

**解决方案**：
1. 检查网络连接
2. 检查API密钥是否正确
3. 检查API代理地址

### 问题3：数据库连接失败

**症状**：`Can't connect to MySQL server`

**解决方案**：
1. 检查数据库配置
2. 确认数据库服务正在运行
3. 检查网络连接和防火墙

### 问题4：重复身份证号

**症状**：`Duplicate entry for key 'PRIMARY'`

**解决方案**：
- 该身份证号已存在于数据库中
- 这是正常的防重复机制
- 如需更新，请先删除旧记录

## 📈 扩展功能

### 可能的改进

1. **批量处理**
   - 支持一次上传多张身份证
   - 批量导入和保存

2. **OCR模型选择**
   - 添加其他OCR服务（百度、腾讯等）
   - 对比识别结果

3. **数据校验**
   - 身份证号校验码验证
   - 出生日期合理性检查

4. **导出功能**
   - 导出为Excel
   - 生成PDF报告

5. **历史记录**
   - 保存识别历史
   - 支持重新编辑和保存

## 📞 技术支持

如有问题，请检查：

1. Python版本（建议3.8+）
2. 依赖包是否正确安装
3. API密钥是否有效
4. 数据库连接是否正常
5. province_data.json文件是否存在

---

**版本**：1.0.0  
**更新日期**：2025-11-09  
**开发团队**：Database Lab Team

